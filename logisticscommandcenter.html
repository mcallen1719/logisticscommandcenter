<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Command Center</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#10b981', // Emerald green for key actions/accents
                        'secondary': '#1f2937', // Dark slate for dashboard background
                        'status-new': '#f59e0b', // Amber
                        'status-processing': '#3b82f6', // Blue
                        'status-ready': '#10b981', // Green
                        'status-shipped': '#6366f1', // Indigo
                        'status-delivered': '#6b7280', // Gray
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styling for status pills */
        .status-pill {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        /* Custom scrollbar for aesthetic */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 4px;
        }
        /* Style for clickable table headers */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen">

    <!-- Header: Logistics Command Center -->
    <header class="bg-secondary text-white shadow-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold tracking-tight">Logistics Command Center</h1>
            <div class="text-sm">
                <span class="font-semibold text-gray-400">User:</span> 
                <span id="userIdDisplay" class="font-mono text-primary">Loading User...</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- 1. KPI Cards (Order Summary) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <!-- Total Pending Orders -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Total Pending</p>
                <p id="kpiPending" class="text-4xl font-extrabold text-secondary mt-1">0</p>
                <p class="text-xs text-gray-400 mt-2">New or In Processing</p>
            </div>
            <!-- Ready for Pickup -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary">
                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Ready for Pickup</p>
                <p id="kpiReady" class="text-4xl font-extrabold text-secondary mt-1">0</p>
                <p class="text-xs text-gray-400 mt-2">Waiting for Carrier Handoff</p>
            </div>
            <!-- Orders Delivered Today -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-gray-500">
                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Delivered Today</p>
                <p id="kpiDelivered" class="text-4xl font-extrabold text-secondary mt-1">0</p>
                <p class="text-xs text-gray-400 mt-2">Completed Shipments</p>
            </div>
        </div>
        
        <!-- 2. Filtering and Search -->
        <div class="bg-white p-4 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row gap-4 items-center">
            
            <!-- Status Filter -->
            <div class="w-full md:w-auto">
                <label for="statusFilter" class="text-sm font-medium text-gray-700 block mb-1">Filter by Status</label>
                <select id="statusFilter" class="w-full md:w-48 p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
                    <option value="all">All Statuses</option>
                    <option value="New">New</option>
                    <option value="Processing">Processing</option>
                    <option value="Ready for Shipment">Ready for Shipment</option>
                    <option value="Shipped">Shipped</option>
                    <option value="Delivered">Delivered</option>
                </select>
            </div>

            <!-- Search Bar -->
            <div class="w-full md:flex-1">
                <label for="searchBar" class="text-sm font-medium text-gray-700 block mb-1">Search Order ID or Customer</label>
                <input type="text" id="searchBar" placeholder="Search orders..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition">
            </div>
        </div>

        <!-- 3. Real-Time Order Table -->
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar max-h-[60vh]">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <!-- Sortable Header: Order ID -->
                            <th id="headerId" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-by="id">
                                Order ID <span id="sort-icon-id" class="ml-1"></span>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <!-- Sortable Header: Time Placed -->
                            <th id="headerTime" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-by="timePlaced">
                                Time Placed <span id="sort-icon-timePlaced" class="ml-1"></span>
                            </th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody" class="bg-white divide-y divide-gray-100">
                        <!-- Order rows injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p id="noResults" class="hidden text-center p-8 text-gray-500">No orders match the current filters or search query.</p>
        </div>

    </main>
    
    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all">
            <!-- Modal Header -->
            <div class="bg-secondary p-4 flex justify-between items-center">
                <h2 id="modalOrderId" class="text-xl font-bold text-white">Order Details: #...</h2>
                <button id="closeModalBtn" class="text-gray-300 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 space-y-4">
                
                <div>
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Customer & Address</p>
                    <p id="modalCustomerName" class="text-lg font-medium text-gray-900"></p>
                    <p id="modalAddress" class="text-sm text-gray-600 font-mono"></p>
                </div>
                
                <div>
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Order Items</p>
                    <ul id="modalItemsList" class="space-y-2 text-sm text-gray-700 bg-gray-50 p-4 rounded-lg">
                        <!-- Items injected here -->
                    </ul>
                </div>

                <div>
                    <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Current Status</p>
                    <span id="modalStatusPill" class="status-pill mt-1 inline-block"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA AND STATE MANAGEMENT (Simulated Firestore with Local Storage) ---
        
        const STORAGE_KEY = 'logisticsHubOrders';
        
        // This array holds the application's entire state.
        let orders = []; 
        let currentUserId = 'Logistics_User_1'; // Mock user ID for the header
        
        // State for sorting: default to ID ascending
        let sortState = {
            column: 'id',
            direction: 'asc'
        };

        // --- MOCK DATA ---
        
        const mockCustomerNames = ["Alice Smith", "Bob Johnson", "Charlie Brown", "Diana Prince", "Ethan Hunt", "Fiona Glenanne", "George Costanza", "Hannah McKay", "Ivy Green", "Jack Ryan"];
        const mockItems = ["Laptop (1)", "Monitor (1)", "Wireless Mouse (2)", "Keyboard (1)", "Webcam (1)", "Router (1)", "HDMI Cable (3)", "Portable SSD (1)"];
        const mockAddresses = [
            "123 Tech Way, Suite 400, San Jose, CA 95110",
            "45 Digital Blvd, Dallas, TX 75201",
            "789 Cloud Ave, Floor 10, Seattle, WA 98101",
            "10 Data Lane, Miami, FL 33101",
            "20 Logic Circuit, Boston, MA 02108"
        ];
        const statusSequence = ["New", "Processing", "Ready for Shipment", "Shipped", "Delivered"];

        // Helper to generate a unique-looking short ID
        const generateShortId = () => Math.random().toString(36).substring(2, 8).toUpperCase();

        // Helper to get a random item from an array
        const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
        
        // Helper to generate mock order details
        function getMockAddressAndItems(customerName) {
            const address = getRandomItem(mockAddresses);
            const numItems = Math.floor(Math.random() * 3) + 1; // 1 to 3 items
            const items = [];
            let itemPool = [...mockItems]; // Use a copy of the pool
            
            for (let i = 0; i < numItems; i++) {
                if (itemPool.length === 0) break;
                const itemIndex = Math.floor(Math.random() * itemPool.length);
                items.push(itemPool[itemIndex]);
                itemPool.splice(itemIndex, 1); // Remove to prevent duplicates in one order
            }
            return { address, items };
        }

        // --- LOCAL STORAGE PERSISTENCE ---

        function saveOrdersToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
            } catch (error) {
                console.error("Error saving to local storage:", error);
            }
        }

        function loadOrdersFromLocalStorage() {
            try {
                const storedOrders = localStorage.getItem(STORAGE_KEY);
                if (storedOrders) {
                    return JSON.parse(storedOrders);
                }
            } catch (error) {
                console.warn("Could not load orders from local storage, creating initial data.", error);
            }
            return null;
        }

        // Function to populate initial data or load from storage
        function populateInitialData() {
            const loadedOrders = loadOrdersFromLocalStorage();
            if (loadedOrders) {
                orders = loadedOrders;
                console.log(`Loaded ${orders.length} orders from local storage.`);
                return; 
            }

            const initialOrders = [];
            const now = Date.now();
            
            for (let i = 0; i < 10; i++) { // Increased to 10 for better testing
                let status;
                // Ensure a variety of statuses initially
                if (i % 5 === 0) status = "Ready for Shipment";
                else if (i % 5 === 1) status = "Delivered";
                else if (i % 5 === 2) status = "Shipped";
                else if (i % 5 === 3) status = "Processing";
                else status = "New"; 

                // Orders placed within the last 48 hours
                const mockTime = new Date(now - Math.floor(Math.random() * 86400000) * (i < 5 ? 0.5 : 1)).toISOString(); 
                
                const customerName = mockCustomerNames[i % mockCustomerNames.length];
                const details = getMockAddressAndItems(customerName);
                
                initialOrders.push({
                    id: generateShortId(),
                    customerName: customerName,
                    status: status,
                    timePlaced: mockTime,
                    ...details // Adds address and items
                });
            }
            orders = initialOrders;
            saveOrdersToLocalStorage(); // Save initial data
        }

        // --- CORE RENDER FUNCTIONS ---

        // Renders all three KPI summary cards
        function renderKPIs() {
            // Get today's date start (midnight)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const midnightTimestamp = today.getTime();

            const pendingCount = orders.filter(o => o.status === 'New' || o.status === 'Processing').length;
            const readyCount = orders.filter(o => o.status === 'Ready for Shipment').length;
            
            const deliveredCount = orders.filter(o => {
                // Check if status is Delivered AND timePlaced is today
                if (o.status !== 'Delivered') return false;
                const orderTime = new Date(o.timePlaced).getTime();
                return orderTime >= midnightTimestamp;
            }).length;

            document.getElementById('kpiPending').textContent = pendingCount;
            document.getElementById('kpiReady').textContent = readyCount;
            document.getElementById('kpiDelivered').textContent = deliveredCount;
        }

        // Renders the main order table based on current filters and search
        function renderTable(filteredOrders = orders) {
            const tbody = document.getElementById('orderTableBody');
            tbody.innerHTML = '';
            
            if (filteredOrders.length === 0) {
                document.getElementById('noResults').classList.remove('hidden');
                return;
            }
            document.getElementById('noResults').classList.add('hidden');

            filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                // Added data-id for modal, and cursor-pointer for visual feedback
                row.className = 'hover:bg-gray-50 transition duration-150 cursor-pointer'; 
                row.dataset.id = order.id; // Store ID on the row for click handling
                
                const [statusClass, nextActionText] = getStatusData(order.status);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" onclick="openOrderDetails('${order.id}')">${order.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" onclick="openOrderDetails('${order.id}')">${order.customerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap" onclick="openOrderDetails('${order.id}')">
                        <span class="status-pill ${statusClass}">${order.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" onclick="openOrderDetails('${order.id}')">${formatTime(order.timePlaced)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        ${nextActionText ? 
                            `<button data-id="${order.id}" class="action-btn bg-primary text-white py-1 px-3 rounded-full text-xs font-semibold hover:bg-emerald-600 transition duration-150">
                                ${nextActionText}
                            </button>`
                            : `<span class="text-gray-400 text-xs">COMPLETE</span>`}
                    </td>
                `;
                tbody.appendChild(row);
            });
            // Update sort icons after rendering
            updateSortIcons();
        }
        
        // --- UTILITY HELPERS ---

        // Returns Tailwind class and next action text based on current status
        function getStatusData(status) {
            switch (status) {
                case 'New':
                    return ['bg-status-new text-white', 'Start Processing'];
                case 'Processing':
                    return ['bg-status-processing text-white', 'Mark Ready for Shipment'];
                case 'Ready for Shipment':
                    return ['bg-status-ready text-white', 'Mark Shipped'];
                case 'Shipped':
                    return ['bg-status-shipped text-white', 'Mark Delivered'];
                case 'Delivered':
                    return ['bg-status-delivered text-white', null];
                default:
                    return ['bg-gray-200 text-gray-800', 'Update Status'];
            }
        }

        // Formats the timestamp to a readable local string
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }
        
        // --- SORTING LOGIC ---

        // Updates the visual indicators for sorting
        function updateSortIcons() {
            // Clear all icons
            document.getElementById('sort-icon-id').innerHTML = '';
            document.getElementById('sort-icon-timePlaced').innerHTML = '';

            const iconElement = document.getElementById(`sort-icon-${sortState.column}`);
            if (iconElement) {
                iconElement.innerHTML = sortState.direction === 'asc' 
                    ? '&#x25B2;' // Up arrow
                    : '&#x25BC;'; // Down arrow
            }
        }

        // Sorts the main orders array
        function sortOrders(column) {
            if (sortState.column === column) {
                // Toggle direction if clicking the same column
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, reset to ascending
                sortState.column = column;
                sortState.direction = 'asc';
            }

            orders.sort((a, b) => {
                let comparison = 0;
                
                if (column === 'timePlaced') {
                    // Compare timestamps as numbers
                    const dateA = new Date(a.timePlaced).getTime();
                    const dateB = new Date(b.timePlaced).getTime();
                    comparison = dateA - dateB;
                } else if (column === 'id') {
                    // Compare IDs (strings)
                    comparison = a.id.localeCompare(b.id);
                }

                return sortState.direction === 'asc' ? comparison : comparison * -1;
            });

            // Re-render the dashboard to show sorted results
            updateDashboard();
        }

        // --- FILTERING LOGIC ---

        // Applies filters and search text to the orders array
        function applyFiltersAndSearch() {
            const status = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchBar').value.toLowerCase().trim();

            let filtered = orders; // Use the globally sorted 'orders' array

            // 1. Status Filter
            if (status !== 'all') {
                filtered = filtered.filter(order => order.status === status);
            }

            // 2. Search Filter
            if (searchTerm) {
                filtered = filtered.filter(order => 
                    order.id.toLowerCase().includes(searchTerm) ||
                    order.customerName.toLowerCase().includes(searchTerm)
                );
            }
            
            // Re-render the table with the filtered results
            renderTable(filtered);
        }

        // --- ACTION HANDLERS ---

        // Advances the status of a specific order
        function advanceOrderStatus(orderId) {
            const orderIndex = orders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return console.error("Order not found.");

            const currentStatus = orders[orderIndex].status;
            let nextStatus;
            
            switch (currentStatus) {
                case 'New':
                    nextStatus = 'Processing';
                    break;
                case 'Processing':
                    nextStatus = 'Ready for Shipment';
                    break;
                case 'Ready for Shipment':
                    nextStatus = 'Shipped';
                    break;
                case 'Shipped':
                    nextStatus = 'Delivered';
                    // Update timestamp to "now" for Delivered Today KPI calculation
                    orders[orderIndex].timePlaced = new Date().toISOString(); 
                    break;
                default:
                    return; // Do nothing if already Delivered
            }

            orders[orderIndex].status = nextStatus;
            
            // Save the updated state and refresh the dashboard
            saveOrdersToLocalStorage();
            updateDashboard();
        }
        
        // --- MODAL HANDLERS ---

        function openOrderDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            // Populate Modal Content
            document.getElementById('modalOrderId').textContent = `Order Details: #${order.id}`;
            document.getElementById('modalCustomerName').textContent = order.customerName;
            document.getElementById('modalAddress').textContent = order.address;
            
            const [statusClass, ] = getStatusData(order.status);
            const statusPill = document.getElementById('modalStatusPill');
            statusPill.textContent = order.status;
            statusPill.className = `status-pill mt-1 inline-block ${statusClass}`;

            const itemsList = document.getElementById('modalItemsList');
            itemsList.innerHTML = '';
            order.items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                itemsList.appendChild(li);
            });

            // Show Modal
            const modal = document.getElementById('orderDetailsModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeOrderDetails() {
            const modal = document.getElementById('orderDetailsModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Main function to refresh the entire UI
        function updateDashboard() {
            renderKPIs();
            applyFiltersAndSearch();
        }

        // --- INITIALIZATION ---
        
        function initApp() {
            // Set up the user ID display
            document.getElementById('userIdDisplay').textContent = currentUserId;

            // 1. Populate initial mock data (or load from storage)
            populateInitialData(); 
            
            // 2. Attach Global Event Listeners (Filters, Search)
            document.getElementById('statusFilter').addEventListener('change', applyFiltersAndSearch);
            document.getElementById('searchBar').addEventListener('input', applyFiltersAndSearch);
            
            // 3. Attach Sorting Listeners
            document.getElementById('headerId').addEventListener('click', () => sortOrders('id'));
            document.getElementById('headerTime').addEventListener('click', () => sortOrders('timePlaced'));

            // 4. Attach Modal Listeners
            document.getElementById('closeModalBtn').addEventListener('click', closeOrderDetails);
            // Close modal when clicking outside (on the overlay)
            document.getElementById('orderDetailsModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('orderDetailsModal')) {
                    closeOrderDetails();
                }
            });

            // 5. Delegation for action buttons (Status Updates)
            document.getElementById('orderTableBody').addEventListener('click', (e) => {
                const btn = e.target.closest('.action-btn');
                if (btn) {
                    // Stop event propagation so the row click doesn't open the modal
                    e.stopPropagation(); 
                    const orderId = btn.dataset.id;
                    advanceOrderStatus(orderId);
                }
            });

            // 6. Initial Render
            sortOrders('timePlaced'); // Initial sort by time placed (newest first)
            updateDashboard();
            
            // 7. Simulate Real-Time Updates (KPIs refresh every 10 seconds)
            setInterval(renderKPIs, 10000); 
            console.log("Logistics Dashboard loaded. Data is stored in localStorage and is persistent.");
        }
        
        // Start the application when the window loads
        window.onload = initApp;

    </script>
</body>
</html>
